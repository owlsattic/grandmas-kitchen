<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grandmaâ€™s Pantry â€¢ Shop</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .skeleton{background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton.img{width:200px;height:200px;border-radius:12px;margin:0 auto 10px}
    .skeleton.text{height:16px;border-radius:8px;margin:6px 0}

    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#eef3ee;color:#2f5130;text-decoration:none;font-size:.8rem}
    .line-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

    /* admin-only */
    article.card{position:relative}
    .admin-archive{position:absolute;top:6px;right:6px;background:#b33;color:#fff;border:0;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.9rem;box-shadow:0 1px 4px rgba(0,0,0,.15)}
    article.card.broken{outline:2px dashed #b33}
    .broken img{opacity:.6}

    /* toolbar */
    #toolbar{max-width:960px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #catPick{padding:.5rem .6rem;border:1px solid #cfcfcf;border-radius:8px}
    .muted{color:#666}
  </style>
</head>
<body>

<header class="container center">
  <a href="/index.html">
    <img class="site-logo" src="/images/logo.jpg" alt="Grandmaâ€™s Kitchen Logo">
  </a>
  <nav aria-label="Primary">
    <a href="/index.html">Home</a>
    <a href="/about.html">About</a>
    <a href="/recipes.html">Recipes</a>
    <a href="/shop.html" aria-current="page">Shop</a>
  </nav>
  <p class="lead">Staples we actually use at homeâ€”simple, honest ingredients.</p>
</header>

<main>
  <div class="container container--narrow">
    <h1>ðŸ›’ Grandmaâ€™s Pantry</h1>
    <p id="catNote" class="muted" style="margin-top:-.5rem"></p>
  </div>

  <!-- Category toolbar -->
  <div id="toolbar" aria-label="Filters">
    <label for="catPick" class="muted" style="font-size:.95rem">Category</label>
    <select id="catPick">
      <option value="">All categories</option>
    </select>
    <span id="countNote" class="muted" style="margin-left:auto"></span>
  </div>

  <div class="container">
    <div id="grid" class="grid grid-2" aria-live="polite">
      <!-- skeletons -->
      <article class="card"><div class="skeleton img"></div><div class="skeleton text" style="width:60%"></div><div class="skeleton text" style="width:90%"></div></article>
      <article class="card"><div class="skeleton img"></div><div class="skeleton text" style="width:70%"></div><div class="skeleton text" style="width:85%"></div></article>
    </div>
  </div>
</main>

<footer class="container container--narrow">
  <p>Â© 2025 Grandmaâ€™s Kitchen â€¢ All rights reserved</p>
  <p class="affiliate-note">As an Amazon Associate, we (Grandma's Kitchen) earn from qualifying purchases.</p>
</footer>

<script>
(async function () {
  // ---------- helpers ----------
  const grid = document.getElementById('grid');
  const catNote = document.getElementById('catNote');
  const catPick = document.getElementById('catPick');
  const countNote = document.getElementById('countNote');

  const params = new URLSearchParams(location.search);
  // support both ?category= and legacy ?cat=
  let currentCat = (params.get('category') || params.get('cat') || '').toLowerCase();

  const esc = (s) => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const slugify = s => String(s||'')
    .toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

  let ALL = []; // full list
  const catMap = new Map(); // slug -> nice name

  function catOf(p){
    const name = p.category_name || p.amazon_category || p.product_type || '';
    const slug = p.category_slug || slugify(name);
    return { slug, name: name || (slug && slug.replace(/-/g,' ')) || '' };
  }

  function syncUrl(){
    const q = new URLSearchParams(location.search);
    if (currentCat) { q.set('category', currentCat); q.delete('cat'); }
    else { q.delete('category'); q.delete('cat'); }
    history.replaceState(null, '', location.pathname + (q.toString()?`?${q}`:''));
  }

  function setCatNote(){
    if (!currentCat) { catNote.textContent = ''; return; }
    const name = catMap.get(currentCat) || currentCat.replace(/-/g,' ');
    catNote.innerHTML =
      `Filtering by category: <a class="chip" href="/shop.html?category=${encodeURIComponent(currentCat)}">${esc(name)}</a> ` +
      `&nbsp; <a href="/shop.html" class="muted">(clear)</a>`;
  }

  function populatePicker(){
    const options = [...catMap.entries()].sort((a,b)=>a[1].localeCompare(b[1]));
    catPick.innerHTML = `<option value="">All categories</option>` +
      options.map(([slug,name]) => `<option value="${esc(slug)}"${slug===currentCat?' selected':''}>${esc(name)}</option>`).join('');
  }

  function render(items){
    countNote.textContent = `${items.length} item${items.length===1?'':'s'}`;
    if (!items.length){
      grid.innerHTML = `<p class="muted">No products found.</p>`;
      return;
    }

    grid.innerHTML = items.map(p => {
      const title = p.my_title || p.amazon_title || 'Product';
      const img   = p.image_main || p.image_small || '';
      const slug  = p.slug || p.product_num || '';
      const { slug: cslug, name: cname } = catOf(p);
      return `
        <article class="card" aria-labelledby="prod-${esc(slug)}-title">
          <a class="product-image" href="/products/${encodeURIComponent(slug)}">
            ${img ? `<img loading="lazy" decoding="async" src="${esc(img)}" alt="${esc(title)}">` : ''}
          </a>
          <h3 id="prod-${esc(slug)}-title" class="product-title line-2">
            <a href="/products/${encodeURIComponent(slug)}">${esc(title)}</a>
          </h3>
          ${cslug ? `<p class="muted" style="margin:.25rem 0 .5rem">
              <a class="chip" href="/shop.html?category=${encodeURIComponent(cslug)}">${esc(cname)}</a>
            </p>` : ''}
          <p><a class="btn" href="/products/${encodeURIComponent(slug)}">View product</a></p>
        </article>
      `;
    }).join('');
  }

  function applyFilter(){
    const shown = currentCat
      ? ALL.filter(p => (p.category_slug || slugify(p.category_name || p.amazon_category || p.product_type || '')) === currentCat)
      : ALL;
    render(shown);
    setCatNote();
  }

  // ---------- data load ----------
  try {
    const url = new URL('/api/shop-list', location.origin);
    url.searchParams.set('limit', '500'); // fetch once; filter client-side
    const r = await fetch(url, { cache: 'no-store' });
    const data = await r.json();
    const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
    ALL = items;

    // collect categories
    for (const p of ALL){
      const {slug,name} = catOf(p);
      if (slug) catMap.set(slug, name);
    }

    populatePicker();
    applyFilter();

    // admin overlay (archive) only with ?admin=1
    if ((new URLSearchParams(location.search)).get('admin') === '1') {
      const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
      for (let i=0;i<20;i++){ await wait(50); if (document.querySelector('#grid article')) break; }
      document.querySelectorAll('#grid article.card').forEach(card => {
        const a = card.querySelector('a.product-image');
        const href = a?.getAttribute('href') || '';
        const slug = decodeURIComponent(href.split('/').pop() || '');
        if (!slug) return;

        const img = card.querySelector('.product-image img');
        if (img) img.addEventListener('error', ()=>card.classList.add('broken'), { once:true });

        const btn = document.createElement('button');
        btn.className = 'admin-archive';
        btn.textContent = 'Archive';
        btn.title = `Hide this product (${slug}) from site`;
        btn.addEventListener('click', async () => {
          if (!confirm(`Archive product ${slug}?`)) return;
          const r = await fetch(`/api/admin/products/${encodeURIComponent(slug)}/archive`, {
            method:'POST', credentials:'include',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ reason: 'archived from shop overlay' })
          });
          const j = await r.json();
          if (!r.ok) { alert(j?.error || 'Archive failed'); return; }
          card.remove();
        });
        card.appendChild(btn);
      });
    }
  } catch (err) {
    console.error(err);
    grid.innerHTML = `<p class="muted">Sorry, the shop is unavailable right now.</p>`;
  }

  // ---------- interactions ----------
  catPick.addEventListener('change', () => {
    currentCat = catPick.value;
    syncUrl();
    applyFilter();
  });
})();
</script>
</body>
</html>
